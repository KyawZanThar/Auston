<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auston Book - Settings</title>
    
    <!-- 1. Link to the new, single, central stylesheet -->
    <link rel="stylesheet" href="../CSS/myaccount.css">
    <link rel="stylesheet" href="../CSS/sidebar.css">
    <link rel="stylesheet" href="../CSS/topbar.css">
</head>
<body>
   <div class="app">
        <div id="sidebar-placeholder"></div>
        <main class="main-content">
            <div id="topbar-placeholder"></div>
            <div class="content-area">
                
                <!-- Ensure this is the ONLY element with id="profile-form" -->
                <form class="settings-container" id="profile-form">
                    <section class="settings-section">
                        <h2>Manage Account</h2>
                        <div class="settings-row">
                            <div class="settings-label">Full Name</div>
                            <div class="settings-value"><input type="text" id="fullNameInput" name="username" /></div>
                        </div>
                        <div class="settings-row">
                            <div class="settings-label">Profile Picture</div>
                            <div class="settings-value"><img class="profile-pic-img" id="profilePicImg" src="https://placehold.co/48x48" alt="Profile Picture" /></div>
                            <div>
                                <button type="button" class="btn" id="uploadButton">Upload</button>
                                <input type="file" id="avatarUpload" name="avatar" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </section>
                    <!-- ... other sections ... -->
                    <div class="save-section">
                        <button type="submit" class="save-btn">Save Changes</button>
                    </div>
                </form>
                
            </div>
        </main>
    </div>
    <!-- SCRIPTS -->
    <!-- In: myaccount.html (at the end of the <body>) -->

<script src="../config/appConfig.js"></script>
<!-- In: myaccount.html (this is the main script for the page) -->
<script>
    // --- THIS IS THE CRITICAL FIX ---
    // We wrap ALL the code in one DOMContentLoaded listener.
   document.addEventListener("DOMContentLoaded", function() {
            
            // --- THIS IS THE CRITICAL FIX ---
            // We will add a check right at the beginning.
            const form = document.getElementById('profile-form');

            // If the form cannot be found, stop immediately and show an error.
            if (!form) {
                console.error("FATAL ERROR: Could not find the element with id='profile-form'. The script cannot continue.");
                alert("A critical page error occurred. Could not initialize the settings form.");
                return; // Stop all further execution
            }
            
            // If we get past this point, we know 'form' is a valid element.

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const token = localStorage.getItem('mock_token');

            if (!currentUser || !token) {
                window.location.href = 'login.html';
                return;
            }

            // --- DOM ELEMENTS ---
            const fullNameInput = document.getElementById('fullNameInput');
            const profilePicImg = document.getElementById('profilePicImg');
            const avatarUploadInput = document.getElementById('avatarUpload');
            const uploadButton = document.getElementById('uploadButton');
            const saveButton = form.querySelector('.save-btn'); // This is now safe

            function populateForm() {
                if (fullNameInput) fullNameInput.value = currentUser.username || '';
                if (profilePicImg) {
                    if (currentUser.avatarUrl) {
                        profilePicImg.src = `${backendDomain}${currentUser.avatarUrl}`;
                    } else {
                        profilePicImg.src = `https://i.pravatar.cc/150?u=${currentUser.id}`;
                    }
                }
            }

            if (uploadButton) {
                uploadButton.addEventListener('click', () => avatarUploadInput.click());
            }
            if (avatarUploadInput) {
                avatarUploadInput.addEventListener('change', function(event) {
                    const [file] = event.target.files;
                    if (file) profilePicImg.src = URL.createObjectURL(file);
                });
            }

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
                try {
                    const formData = new FormData();
                    formData.append('username', fullNameInput.value);
                    if (avatarUploadInput.files[0]) {
                        formData.append('avatar', avatarUploadInput.files[0]);
                    }
                    const response = await fetch(`${backendDomain}/api/users/profile`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Failed to update profile.');
                    
                    localStorage.setItem('mock_token', result.token);
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    alert('Profile updated successfully!');
                    window.location.reload();
                } catch (error) {
                    console.error('Update failed:', error);
                    alert(`Error: ${error.message}`);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            });

            populateForm();
        });
    </script>

<!-- Your component loader script goes here -->
<script src="../Javascript/componentUpload.js"></script>
</body>
</html>