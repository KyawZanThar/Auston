<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auston Book - Admin Dashboard</title>
    <link rel="stylesheet" href="../CSS/sidebar.css">
     <link rel="stylesheet" href="../CSS/topbar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- This is the corrected and cleaned-up style block -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
        }
        .main-content{
            margin-left: 300px;
            width: 100%;
        }
        .content-area { display: flex; flex-grow: 1; overflow: hidden; padding: 24px; gap: 32px; }
        .left-panel { flex: 2.5; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-right: 8px; }
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; }
        .admin-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgb(0 0 0 / 0.05); }
        .admin-card h2 { margin: 0 0 20px 0; font-weight: 700; font-size: 22px; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        .admin-card h2 svg { width: 24px; height: 24px; fill: #fca311; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: #f8f9fb; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #14213d; margin-bottom: 8px; }
        .stat-card .label { font-size: 14px; color: #555; }
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #eee; }
        .user-table th { background-color: #f8f9fb; font-weight: 600; color: #14213d; }
        .user-table tr:hover { background-color: #f8f9fb; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status.admin { background-color: #eef2ff; color: #4338ca; }
        .status.student { background-color: #e6f4ea; color: #0d6831; }
        .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; border: none; }
        .approve-btn { background-color: #22c55e; color: white; } .approve-btn:hover { background-color: #16a34a; }
        .reject-btn { background-color: #ef4444; color: white; } .reject-btn:hover { background-color: #dc2626; }
        .book-list { display: flex; flex-direction: column; gap: 16px; }
        .book-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8f9fb; border-radius: 8px; }
        .book-item img { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .book-info { flex-grow: 1; min-width: 0; }
        .book-info h3 { margin: 0 0 4px 0; font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info p { margin: 0; font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-actions { display: flex; gap: 8px; }
        .left-panel::-webkit-scrollbar, .right-panel::-webkit-scrollbar { width: 8px; }
        .left-panel::-webkit-scrollbar-thumb, .right-panel::-webkit-scrollbar-thumb { background: #fca311; border-radius: 4px; }
    </style>
</head>

<body>
    <div class="app">
       <div id="sidebar-placeholder"></div>
        <main class="main-content">
           <div id="topbar-placeholder"></div>
            <section class="content-area">
                <section class="left-panel">
                    <section class="admin-card">
                        <h2>Dashboard Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div id="total-users-stat" class="number">0</div>
                                <div class="label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div id="total-books-stat" class="number">0</div>
                                <div class="label">Total Books</div>
                            </div>
                            <div class="stat-card">
                                <div id="pending-books-stat" class="number">0</div>
                                <div class="label">Pending Approvals</div>
                            </div>
                            <div class="stat-card">
                                <div id="approved-books-stat" class="number">0</div>
                                <div class="label">Approved Books</div>
                            </div>
                        </div>
                    </section>

                    <section class="admin-card">
                        <h2>User Management</h2>
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body">
                                <!-- User data will be loaded here by JS -->
                            </tbody>
                        </table>
                    </section>
                </section>

                <section class="right-panel">
                    <section class="admin-card">
                        <h2>Recent Books Added (Pending Approval)</h2>
                        <div class="book-list" id="pending-books-list">
                            <!-- Pending books will be loaded here by JS -->
                        </div>
                    </section>
                </section>
            </section>
        </main>
    </div>

    <!-- ALL JAVASCRIPT IS NOW CONSOLIDATED HERE, AT THE END OF THE BODY -->
    <script src="../config/appConfig.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Use the 'backendDomain' variable from your config.js file
            const API_BASE_URL_BOOKS = `${backendDomain}/api/books`;
            const API_BASE_URL_USERS = `${backendDomain}/api/users`;
            const token = localStorage.getItem('mock_token');

            if (!token) {
                // If not logged in as admin, redirect or show an error
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center;"><h1>Access Denied</h1><p>You must be logged in as an admin to view this page.</p><a href="login.html">Go to Login</a></div>';
                return;
            }

            // --- DATA FETCHING FUNCTIONS ---

            async function fetchAllBooks() {
                try {
                    const response = await fetch(`${API_BASE_URL_BOOKS}/admin/all`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch books');
                    const books = await response.json();
                    
                    // Filter books by status
                    const pendingBooks = books.filter(b => b.status === 'pending');
                    const approvedBooks = books.filter(b => b.status === 'approved');

                    // Update UI
                    updateStats(books, pendingBooks);
                    renderPendingBooks(pendingBooks);
                } catch (error) {
                    console.error('Error fetching books:', error);
                    document.getElementById('pending-books-list').innerHTML = `<p class="text-red-500">${error.message}</p>`;
                }
            }

            async function fetchAllUsers() {
                try {
                    const response = await fetch(API_BASE_URL_USERS, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch users');
                    const users = await response.json();
                    renderUsers(users);
                } catch (error) {
                    console.error('Error fetching users:', error);
                    document.getElementById('user-table-body').innerHTML = `<tr><td colspan="4" class="text-red-500">${error.message}</td></tr>`;
                }
            }

            // --- UI RENDERING FUNCTIONS ---

            function updateStats(allBooks, pendingBooks) {
                document.getElementById('total-books-stat').textContent = allBooks.length;
                document.getElementById('pending-books-stat').textContent = pendingBooks.length;
                document.getElementById('approved-books-stat').textContent = allBooks.length - pendingBooks.length;
            }

            function renderPendingBooks(books) {
                const list = document.getElementById('pending-books-list');
                list.innerHTML = '';
                if (books.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">No books are currently pending approval.</p>';
                    return;
                }
                books.forEach(book => {
                    const item = document.createElement('div');
                    item.className = 'book-item';
                    item.setAttribute('data-book-id', book._id);
                    item.innerHTML = `
                        <img src="${book.fileUrl}" alt="Book Cover Placeholder" onerror="this.src='https://via.placeholder.com/40x60.png?text=PDF'">
                        <div class="book-info">
                            <h3>${sanitizeHTML(book.title)}</h3>
                            <p>by ${sanitizeHTML(book.author)}</p>
                            <p class="text-xs text-gray-400">Uploader: ${sanitizeHTML(book.uploadedBy)}</p>
                        </div>
                        <div class="book-actions">
                            <button class="action-btn approve-btn" onclick="window.approveBook('${book._id}')">Approve</button>
                            <button class="action-btn reject-btn" onclick="window.rejectBook('${book._id}')">Reject</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }

            function renderUsers(users) {
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';
                document.getElementById('total-users-stat').textContent = users.length;

                users.forEach(user => {
                    const row = document.createElement('tr');
                    const roleClass = user.role === 'admin' ? 'admin' : 'student';
                    row.innerHTML = `
                        <td>${sanitizeHTML(user.austonId)}</td>
                        <td>${sanitizeHTML(user.username)}</td>
                        <td>${sanitizeHTML(user.email)}</td>
                        <td><span class="status ${roleClass}">${sanitizeHTML(user.role)}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // --- ACTION FUNCTIONS ---

            window.approveBook = async function(bookId) {
                const button = document.querySelector(`[data-book-id="${bookId}"] .approve-btn`);
                button.disabled = true;
                button.textContent = '...';
                try {
                    const response = await fetch(`${API_BASE_URL_BOOKS}/approve/${bookId}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Approval failed');
                    
                    // Instant UI update: remove the item from the pending list
                    const itemToRemove = document.querySelector(`[data-book-id="${bookId}"]`);
                    if (itemToRemove) itemToRemove.remove();
                    
                    // Re-fetch all data to update stats correctly
                    fetchAllBooks();

                } catch (error) {
                    console.error('Error approving book:', error);
                    button.textContent = 'Error';
                    button.style.backgroundColor = '#ef4444';
                }
            }

            window.rejectBook = async function(bookId) {
                // Similar logic to approveBook can be implemented here
                alert(`Rejecting book with ID: ${bookId} (functionality to be implemented)`);
            }
            
            function sanitizeHTML(str) {
                if (!str) return '';
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }

            // --- INITIALIZATION ---
            fetchAllBooks();
            fetchAllUsers();
        });
    </script>
    <script src="../Javascript/componentUpload.js"></script>
</body>
</html>