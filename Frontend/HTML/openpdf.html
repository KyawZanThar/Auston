<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Read PDF - Auston</title>
  <!-- All your existing CSS is correct and included here -->
  <style>
    /* Reset & base */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fb; color: #1a1a1a; height: 100vh; display: flex; overflow: hidden; }
    img { display: block; max-width: 100%; height: auto; }
    button { cursor: pointer; border: none; outline: none; background: none; }
    a { text-decoration: none; color: inherit; }
    /* Sidebar */
    .sidebar { width: 220px; background-color: #14213d; color: white; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 0; flex-shrink: 0; transition: width 0.3s ease; }
    .sidebar .logo { font-weight: 700; font-size: 24px; color: #fca311; padding-left: 20px; margin-bottom: 40px; display: flex; align-items: center; gap: 6px; }
    .sidebar .logo svg { width: 24px; height: 24px; fill: #fca311; }
    .sidebar nav { flex-grow: 1; }
    .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar nav ul li { padding: 14px 20px; display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
    .sidebar nav ul li a { display: flex; align-items: center; gap: 12px; width: 100%; color: inherit; text-decoration: none; }
    .sidebar nav ul li:hover { background-color: rgba(252, 163, 17, 0.1); }
    .sidebar nav ul li.active { background-color: #fca311; color: #14213d; border-radius: 6px 0 0 6px; }
    .sidebar nav ul li svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .sidebar .bottom-menu { border-top: 1px solid #2a2f4a; padding-top: 20px; }
    /* Main content */
    .main-content { flex-grow: 1; display: flex; flex-direction: column; background: #fff; overflow: hidden; height: 100vh; }
    /* Top bar */
    .top-bar { background-color: #14213d; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; color: white; flex-shrink: 0; }
    .top-bar .search-container { flex-grow: 1; max-width: 600px; margin: 0 24px; position: relative; }
    .top-bar input[type="search"] { width: 100%; padding: 10px 16px; border-radius: 12px; border: none; font-size: 16px; outline: none; background: rgba(255, 255, 255, 0.1); color: white; }
    .top-bar input[type="search"]::placeholder { color: rgba(255, 255, 255, 0.7); }
    .top-bar .profile { display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
    .top-bar .profile img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fca311; }
    .top-bar .profile span { font-weight: 600; font-size: 16px; }
    /* Breadcrumb */
    .breadcrumb { padding: 12px 32px; background: #f0f0f0; font-size: 14px; color: #555; user-select: none; flex-shrink: 0; }
    .breadcrumb a { color: #14213d; font-weight: 600; text-decoration: none; margin-right: 6px; transition: color 0.2s ease; }
    .breadcrumb a:hover { color: #fca311; }
    .breadcrumb span { margin-right: 6px; color: #999; }
    /* PDF Viewer Container */
    .pdf-viewer-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: #e5e5e5; }
    /* PDF Controls Bar */
    .pdf-controls { background: #14213d; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .pdf-controls .control-group { display: flex; align-items: center; gap: 12px; }
    .pdf-controls button { background: #fca311; color: #14213d; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .pdf-controls button:hover { background: #e89200; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
    .pdf-controls button:disabled { background: #555; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }
    .pdf-controls .page-info { color: white; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .pdf-controls input[type="number"] { width: 60px; padding: 6px 8px; border-radius: 4px; border: none; text-align: center; font-weight: 600; font-size: 14px; background: white; }
    /* PDF Display Area */
    .pdf-display { flex-grow: 1; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding: 24px; background: #e5e5e5; }
    .pdf-canvas-wrapper { background: white; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); border-radius: 8px; overflow: hidden; }
    #pdf-canvas { display: block; }
    /* Loading & Error States */
    .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px; color: #14213d; }
    .loading-spinner { width: 40px; height: 40px; border: 4px solid rgba(252, 163, 17, 0.3); border-radius: 50%; border-top-color: #fca311; animation: spin 1s ease-in-out infinite; margin-bottom: 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-message { font-size: 18px; font-weight: 600; text-align: center; }
    .error-message { color: #e63946; font-size: 16px; font-weight: 600; text-align: center; padding: 48px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); max-width: 600px; margin: 48px auto; }
    /* Book Info Panel */
    .book-info-panel { background: #14213d; color: white; padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    .book-info-panel img { width: 60px; height: 80px; object-fit: cover; border-radius: 6px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .book-details { flex-grow: 1; }
    .book-details h2 { margin: 0 0 4px 0; font-size: 18px; font-weight: 700; }
    .book-details p { margin: 0; color: #fca311; font-weight: 600; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <!-- Your sidebar HTML is correct -->
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <!-- Your top bar HTML is correct -->
    </header>

    <nav class="breadcrumb">
      <!-- Your breadcrumb HTML is correct -->
    </nav>

    <div class="book-info-panel" id="book-info-panel">
      <!-- Book info will be populated by JavaScript -->
    </div>

   <!-- In: openpdf.html -->

<div class="pdf-viewer-container">
  <!-- --- THIS IS THE CORRECTED AND COMPLETE PDF CONTROLS SECTION --- -->
  <div class="pdf-controls">
    
    <!-- Group 1: Page Navigation -->
    <div class="control-group">
      <button id="prev-page" aria-label="Previous page">
        <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Previous
      </button>
      <div class="page-info">
        <span>Page</span>
        <input type="number" id="page-input" min="1" value="1" aria-label="Current page number" />
        <span>of <span id="total-pages">--</span></span>
      </div>
      <button id="next-page" aria-label="Next page">
        Next
        <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <!-- Group 2: Zoom Controls -->
    <div class="control-group zoom-controls">
      <button id="zoom-out" aria-label="Zoom out">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/><path d="M21 21l-4.35-4.35M8 11h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </button>
      <span class="zoom-level" id="zoom-level">150%</span>
      <button id="zoom-in" aria-label="Zoom in">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/><path d="M21 21l-4.35-4.35M11 8v6M8 11h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </button>
    </div>

    <!-- Group 3: Other Actions -->
    <div class="control-group">
      <button id="download-pdf" aria-label="Download PDF">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Download
      </button>
      <button id="fullscreen" aria-label="Toggle fullscreen">
        <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Fullscreen
      </button>
    </div>
  </div>

  <div class="pdf-display" id="pdf-display">
    <!-- ... loading container ... -->
     <div class="loading-container" id="loading-container">  
          <div class="loading-spinner"></div>
          <div class="loading-message">Loading PDF...</div>
  </div>
</div>
  </main>

  <!-- In: openpdf.html (at the bottom of the <body> tag) -->

<script src="../config/appConfig.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
<script>
    // --- THIS IS THE CRITICAL FIX ---
    // We wrap ALL the code in one DOMContentLoaded listener.
    document.addEventListener('DOMContentLoaded', function() {
    
        // Initialize PDF.js worker
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- DOM ELEMENTS ---
        // These are now safely inside the listener, so they will always be found.
        const pdfDisplay = document.getElementById('pdf-display');
        const loadingContainer = document.getElementById('loading-container');
        const bookInfoPanel = document.getElementById('book-info-panel');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInput = document.getElementById('page-input');
        const totalPagesSpan = document.getElementById('total-pages');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomLevelSpan = document.getElementById('zoom-level');
        const downloadBtn = document.getElementById('download-pdf');
        const fullscreenBtn = document.getElementById('fullscreen');

        // --- STATE ---
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let scale = 1.5;
        let isRendering = false;

        /**
         * Main function that starts the viewer.
         */
        async function initializeViewer() {
            const book = JSON.parse(localStorage.getItem('selectedBook'));
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('bookId');

            populateBookInfo(book);

            if (!book || !bookId) {
                showError("Book data missing. Please return to the dashboard and select a book again.");
                return;
            }

            if (book.fileUrl && book.fileUrl.startsWith('http')) {
                loadingContainer.querySelector('.loading-message').innerText = 'Redirecting to external reader...';
                setTimeout(() => { window.location.href = book.fileUrl; }, 1000);
                return;
            }

            const token = localStorage.getItem('mock_token');
            if (!token) {
                showError('Authentication error. You must be logged in to view this file.');
                return;
            }

            const pdfUrl = `${backendDomain}/api/books/mockfile/${bookId}`;
            const options = {
                url: pdfUrl,
                httpHeaders: { 'Authorization': `Bearer ${token}` }
            };
            await loadPdf(options);
        }

        /**
         * Loads and renders a PDF from our backend.
         */
        async function loadPdf(options) {
          try {
            loadingContainer.style.display = 'flex';
            const loadingTask = pdfjsLib.getDocument(options);
            pdfDoc = await loadingTask.promise;
            totalPages = pdfDoc.numPages;
            totalPagesSpan.textContent = totalPages;
            pageInput.max = totalPages;
            await renderPage(1);
          } catch (error) {
            console.error('Error loading PDF:', error);
            if (error.status === 403) showError('Access Denied. You do not have permission to view this file.');
            else if (error.status === 404) showError('The PDF file could not be found on the server.');
            else showError('Failed to load PDF. The file may be corrupted or inaccessible.');
          }
        }
        
        function populateBookInfo(book) {
          try {
            if (book) {
              const coverUrl = book.coverUrl || 'https://placehold.co/60x80/14213d/fca311?text=Book';
              bookInfoPanel.innerHTML = `
                <img src="${coverUrl}" alt="${book.title} cover" />
                <div class="book-details">
                  <h2>${book.title}</h2>
                  <p>by ${book.author}</p>
                </div>
              `;
            } else {
              bookInfoPanel.innerHTML = `<div class="book-details"><h2>PDF Document</h2><p>Reading Mode</p></div>`;
            }
          } catch (e) { console.error('Error populating book info:', e); }
        }

        async function renderPage(pageNum) {
            if (isRendering || !pdfDoc) return;
            isRendering = true;
            try {
                const page = await pdfDoc.getPage(pageNum);
                let canvas = document.getElementById('pdf-canvas');
                if (!canvas) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'pdf-canvas-wrapper';
                    canvas = document.createElement('canvas');
                    canvas.id = 'pdf-canvas';
                    wrapper.appendChild(canvas);
                    pdfDisplay.innerHTML = '';
                    pdfDisplay.appendChild(wrapper);
                }
                loadingContainer.style.display = 'none';
                const context = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                currentPage = pageNum;
                pageInput.value = currentPage;
                updateButtons();
            } catch (error) {
                console.error('Error rendering page:', error);
                showError('Failed to render this page of the PDF.');
            } finally {
                isRendering = false;
            }
        }

        function updateButtons() {
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        function showError(message) {
            pdfDisplay.innerHTML = `<div class="error-message">${message}</div>`;
            loadingContainer.style.display = 'none';
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // --- EVENT LISTENERS ---
        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) renderPage(currentPage - 1); });
        nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) renderPage(currentPage + 1); });
        pageInput.addEventListener('change', (e) => { let pageNum = parseInt(e.target.value); if(pageNum >= 1 && pageNum <= totalPages) renderPage(pageNum); else e.target.value = currentPage; });
        zoomInBtn.addEventListener('click', () => { if (scale < 3) { scale += 0.25; zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`; renderPage(currentPage); } });
        zoomOutBtn.addEventListener('click', () => { if (scale > 0.5) { scale -= 0.25; zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`; renderPage(currentPage); } });
        downloadBtn.addEventListener('click', () => {
            const bookId = new URLSearchParams(window.location.search).get('bookId');
            const book = JSON.parse(localStorage.getItem('selectedBook'));
            if (bookId) {
                const pdfUrl = `${backendDomain}/api/books/mockfile/${bookId}`;
                window.open(pdfUrl, '_blank');
            }
        });
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentPage > 1) renderPage(currentPage - 1);
            else if (e.key === 'ArrowRight' && currentPage < totalPages) renderPage(currentPage + 1);
        });

        // --- INITIALIZATION ---
        // This is the first function that runs inside our safe wrapper.
        initializeViewer();
    });
  </script>
</body>
</html>


